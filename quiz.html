<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehension Quiz</title>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .container {
            max-width: 700px;
            margin: 2rem auto;
            background-color: white;
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .question {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-left: 5px solid #3498db;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .question:hover {
            background-color: #e9ecef;
        }
        .question.correct {
            border-left-color: #27ae60;
            background-color: #d5f4e6;
        }
        .question.incorrect {
            border-left-color: #e74c3c;
            background-color: #fadbd8;
        }
        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            margin: 0.5rem;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .results {
            display: none;
            margin-top: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #e8f4f8, #d1ecf1);
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }
        .metric-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .metric-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .data-export {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        
        /* Radio button styles */
        .option-container {
            margin: 10px 0;
        }
        .option-label {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background-color: white;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .option-label:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }
        .option-label.selected {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        .option-text {
            font-size: 16px;
            line-height: 1.4;
        }
        
        /* Validation warning */
        .validation-warning {
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background-color: #fadbd8;
            border-radius: 8px;
            display: none;
        }

        /* Loading indicator */
        .loading {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        .status-success {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 2px solid #27ae60;
        }
        .status-warning {
            background-color: #fef5e7;
            color: #f39c12;
            border: 2px solid #f39c12;
        }
        .status-error {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† Comprehension Quiz</h1>
        <p>Please answer the following questions based on the text you just read. Select one answer for each question.</p>
        
        <div id="validationWarning" class="validation-warning">
            ‚ö†Ô∏è Please answer all questions before submitting!
        </div>

        <div id="loadingIndicator" class="loading">
            <div class="spinner"></div>
            <p>Saving your results to research database...</p>
        </div>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <form id="quiz-form">
            <div class="question" id="q1-container">
                <p><strong>1. What is the primary focus of the text?</strong></p>
                <div class="option-container">
                    <label class="option-label">
                        <input type="radio" name="q1" value="A">
                        <span class="option-text">A) General insect biology and classification</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q1" value="B">
                        <span class="option-text">B) Monarch butterfly life cycle, migration, and conservation</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q1" value="C">
                        <span class="option-text">C) The anatomy and physiology of butterflies</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q1" value="D">
                        <span class="option-text">D) Gardening techniques for attracting butterflies</span>
                    </label>
                </div>
            </div>
            
            <div class="question" id="q2-container">
                <p><strong>2. What remarkable feat are monarch butterflies known for?</strong></p>
                <div class="option-container">
                    <label class="option-label">
                        <input type="radio" name="q2" value="A">
                        <span class="option-text">A) Changing colors for camouflage</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q2" value="B">
                        <span class="option-text">B) Annual long-distance migration up to 3,000 miles</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q2" value="C">
                        <span class="option-text">C) Living for several years as adults</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q2" value="D">
                        <span class="option-text">D) Building complex nest structures</span>
                    </label>
                </div>
            </div>
            
            <div class="question" id="q3-container">
                <p><strong>3. What plant is essential for monarch reproduction and survival?</strong></p>
                <div class="option-container">
                    <label class="option-label">
                        <input type="radio" name="q3" value="A">
                        <span class="option-text">A) Sunflower plants</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q3" value="B">
                        <span class="option-text">B) Oak tree leaves</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q3" value="C">
                        <span class="option-text">C) Milkweed plants</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q3" value="D">
                        <span class="option-text">D) Rose bushes</span>
                    </label>
                </div>
            </div>
            
            <div class="question" id="q4-container">
                <p><strong>4. How many distinct stages are in the monarch's metamorphosis?</strong></p>
                <div class="option-container">
                    <label class="option-label">
                        <input type="radio" name="q4" value="A">
                        <span class="option-text">A) Three stages</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q4" value="B">
                        <span class="option-text">B) Four stages</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q4" value="C">
                        <span class="option-text">C) Five stages</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q4" value="D">
                        <span class="option-text">D) Six stages</span>
                    </label>
                </div>
            </div>
            
            <div class="question" id="q5-container">
                <p><strong>5. What are the main threats to monarch butterflies mentioned?</strong></p>
                <div class="option-container">
                    <label class="option-label">
                        <input type="radio" name="q5" value="A">
                        <span class="option-text">A) Natural predators and diseases only</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q5" value="B">
                        <span class="option-text">B) Habitat loss, climate change, and reduced milkweed</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q5" value="C">
                        <span class="option-text">C) Overhunting and commercial collection</span>
                    </label>
                    <label class="option-label">
                        <input type="radio" name="q5" value="D">
                        <span class="option-text">D) Air and water pollution exclusively</span>
                    </label>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button type="button" onclick="calculateScore()" class="btn-success">üìä Submit Quiz</button>
                <button type="button" onclick="resetQuiz()" class="btn-danger">üîÑ Start Over</button>
                <button type="button" onclick="testConnection()" class="btn-success">üß™ Test Connection</button>
            </div>
        </form>
        
        <div id="results" class="results">
            <h2>üìà Your Results</h2>
            <div class="performance-metrics">
                <div class="metric-card">
                    <div class="metric-value" id="score-value">0/5</div>
                    <div class="metric-label">Correct Answers</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="time-value">0s</div>
                    <div class="metric-label">Reading Time</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="wpm-value">0</div>
                    <div class="metric-label">Words Per Minute</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="accuracy-value">0%</div>
                    <div class="metric-label">Accuracy Rate</div>
                </div>
            </div>
            
            <div id="result-details">
                <p><strong>Contrast Condition:</strong> <span id="contrast-type-result"></span></p>
                <p><strong>Participant ID:</strong> <span id="participant-id-result"></span></p>
                <p><strong>Completion Time:</strong> <span id="completion-time"></span></p>
                <p id="save-status" style="font-weight: bold; color: #27ae60;"></p>
            </div>
            
            <div class="data-export">
                <h3>üíæ Research Data</h3>
                <button onclick="exportData()">üì• Export My Data (JSON)</button>
                <button onclick="viewAllData()">üìä View All Research Data</button>
                <button onclick="restartExperiment()">üîÑ New Participant</button>
                
                <div id="allDataView" class="hidden" style="margin-top: 1rem; text-align: left;">
                    <h4>All Research Data:</h4>
                    <pre id="allDataDisplay" style="background: #2c3e50; color: white; padding: 1rem; border-radius: 5px; max-height: 300px; overflow-y: auto;"></pre>
                    <button onclick="clearAllData()" class="btn-danger">üóëÔ∏è Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const readingTime = urlParams.get('time');
        const contrastType = urlParams.get('contrast');
        const wordsPerMinute = urlParams.get('wpm');
        
        // Your Google Apps Script URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzV594676lrjZCK9ozse88MTblqutosF5CNzuuq_HtNZGncraoZhLEJVwgT3FeIi_LX/exec';
        
        // Correct answers
        const correctAnswers = {
            q1: 'B',
            q2: 'B', 
            q3: 'C',
            q4: 'B',
            q5: 'B'
        };

        // Initialize radio button interactions
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handlers to all radio labels
            const labels = document.querySelectorAll('.option-label');
            labels.forEach(label => {
                label.addEventListener('click', function() {
                    // Remove selected class from all labels in this question
                    const questionContainer = this.closest('.question');
                    const allLabels = questionContainer.querySelectorAll('.option-label');
                    allLabels.forEach(l => l.classList.remove('selected'));
                    
                    // Add selected class to clicked label
                    this.classList.add('selected');
                    
                    // Check the radio button
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                });
            });

            console.log('Quiz page loaded successfully');
            console.log('Google Script URL:', GOOGLE_SCRIPT_URL);
        });

        function calculateScore() {
            // Check if all questions are answered
            const allAnswered = checkAllQuestionsAnswered();
            if (!allAnswered) {
                document.getElementById('validationWarning').style.display = 'block';
                document.getElementById('validationWarning').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            document.getElementById('validationWarning').style.display = 'none';
            
            let score = 0;
            const userAnswers = {};
            const questionContainers = document.querySelectorAll('.question');
            
            // Check each question
            for (let i = 1; i <= 5; i++) {
                const questionName = 'q' + i;
                const selectedRadio = document.querySelector(`input[name="${questionName}"]:checked`);
                const userAnswer = selectedRadio ? selectedRadio.value : null;
                userAnswers[questionName] = userAnswer;
                
                const questionContainer = document.getElementById(`${questionName}-container`);
                
                if (userAnswer === correctAnswers[questionName]) {
                    score++;
                    questionContainer.classList.add('correct');
                    questionContainer.classList.remove('incorrect');
                } else {
                    questionContainer.classList.add('incorrect');
                    questionContainer.classList.remove('correct');
                }
            }
            
            // Show loading indicator
            document.getElementById('loadingIndicator').style.display = 'block';
            
            // Display results and save to Google Sheets
            displayResults(score, userAnswers);
        }

        function checkAllQuestionsAnswered() {
            for (let i = 1; i <= 5; i++) {
                const questionName = 'q' + i;
                const selectedRadio = document.querySelector(`input[name="${questionName}"]:checked`);
                if (!selectedRadio) {
                    return false;
                }
            }
            return true;
        }

        function displayResults(score, userAnswers) {
            const accuracy = Math.round((score / 5) * 100);
            
            // Update result displays
            document.getElementById('score-value').textContent = `${score}/5`;
            document.getElementById('time-value').textContent = `${readingTime}s`;
            document.getElementById('wpm-value').textContent = wordsPerMinute;
            document.getElementById('accuracy-value').textContent = `${accuracy}%`;
            document.getElementById('contrast-type-result').textContent = contrastType === 'high' ? 'High Contrast' : 'Low Contrast';
            
            const participantId = sessionStorage.getItem('participantId') || 'Unknown';
            document.getElementById('participant-id-result').textContent = participantId;
            
            const completionTime = new Date().toLocaleString();
            document.getElementById('completion-time').textContent = completionTime;
            
            // Show results section
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
            // Save results to Google Sheets and localStorage
            saveResults(score, userAnswers, accuracy);
        }

        function saveResults(score, userAnswers, accuracy) {
            const participantId = sessionStorage.getItem('participantId') || 'Unknown';
            const experimentData = {
                participantId: participantId,
                contrastType: contrastType,
                readingTime: parseInt(readingTime),
                wordsPerMinute: parseInt(wordsPerMinute),
                score: score,
                accuracy: accuracy,
                q1: userAnswers.q1 || 'Not answered',
                q2: userAnswers.q2 || 'Not answered',
                q3: userAnswers.q3 || 'Not answered',
                q4: userAnswers.q4 || 'Not answered',
                q5: userAnswers.q5 || 'Not answered',
                completionTime: new Date().toISOString(),
                startTime: sessionStorage.getItem('startTime')
            };
            
            console.log('Saving data:', experimentData);
            
            // Save to localStorage (backup)
            const allData = JSON.parse(localStorage.getItem('contrastExperimentData') || '[]');
            allData.push(experimentData);
            localStorage.setItem('contrastExperimentData', JSON.stringify(allData));
            console.log('Saved to localStorage');
            
            // Save to Google Sheets via Apps Script
            sendToGoogleSheets(experimentData);
            
            // Update completion count
            const completionCount = parseInt(localStorage.getItem('experimentCompletions') || '0') + 1;
            localStorage.setItem('experimentCompletions', completionCount.toString());
        }

        function sendToGoogleSheets(data) {
            console.log('Sending data to Google Sheets via Apps Script...');
            
            // Show loading state
            document.getElementById('save-status').textContent = '‚è≥ Saving to database...';
            document.getElementById('save-status').style.color = '#f39c12';

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log('Response received:', response);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Successfully saved to Google Sheets:', result);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('save-status').textContent = '‚úÖ Successfully saved to research database!';
                document.getElementById('save-status').style.color = '#27ae60';
                
                // Show success alert
                showStatus('‚úÖ Your results have been automatically saved to the research database!', 'success');
            })
            .catch(error => {
                console.error('Error saving to Google Sheets:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('save-status').textContent = '‚ö†Ô∏è Saved locally (server connection failed)';
                document.getElementById('save-status').style.color = '#e74c3c';
                
                // Download CSV as backup
                downloadCSVBackup(data);
                showStatus('‚ö†Ô∏è Results saved locally as CSV backup.', 'warning');
            });
        }

        function downloadCSVBackup(data) {
            const csvData = [
                ['ParticipantID', 'ContrastType', 'ReadingTime', 'WordsPerMinute', 'Score', 'Accuracy', 'Q1', 'Q2', 'Q3', 'Q4', 'Q5', 'Timestamp'],
                [
                    data.participantId,
                    data.contrastType,
                    data.readingTime,
                    data.wordsPerMinute,
                    data.score,
                    data.accuracy + '%',
                    data.q1,
                    data.q2,
                    data.q3,
                    data.q4,
                    data.q5,
                    new Date().toLocaleString()
                ]
            ];
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvData.forEach(row => {
                csvContent += row.join(",") + "\r\n";
            });
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `contrast_backup_${data.participantId}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Test connection function
        function testConnection() {
            const testData = {
                participantId: 'TEST_USER_' + Date.now(),
                contrastType: 'test',
                readingTime: 30,
                wordsPerMinute: 250,
                score: 5,
                accuracy: 100,
                q1: 'B',
                q2: 'B',
                q3: 'C',
                q4: 'B',
                q5: 'B',
                completionTime: new Date().toISOString(),
                startTime: new Date().toISOString()
            };

            console.log('Testing connection with data:', testData);
            showStatus('üß™ Testing connection to Google Sheets...', 'warning');
            document.getElementById('loadingIndicator').style.display = 'block';

            sendToGoogleSheets(testData);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = 'status-message';
            
            switch(type) {
                case 'success':
                    statusDiv.classList.add('status-success');
                    break;
                case 'warning':
                    statusDiv.classList.add('status-warning');
                    break;
                case 'error':
                    statusDiv.classList.add('status-error');
                    break;
            }
            
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function resetQuiz() {
            // Clear all radio buttons
            const radios = document.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => radio.checked = false);
            
            // Clear selected classes
            const labels = document.querySelectorAll('.option-label');
            labels.forEach(label => label.classList.remove('selected'));
            
            // Reset question styles
            const questions = document.querySelectorAll('.question');
            questions.forEach(question => {
                question.classList.remove('correct', 'incorrect');
            });
            
            // Hide results and validation warning
            document.getElementById('results').style.display = 'none';
            document.getElementById('validationWarning').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function exportData() {
            const participantId = sessionStorage.getItem('participantId') || 'Unknown';
            const allData = JSON.parse(localStorage.getItem('contrastExperimentData') || '[]');
            const userData = allData.find(data => data.participantId === participantId);
            
            if (userData) {
                const dataStr = JSON.stringify(userData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `contrast-experiment-${participantId}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        }

        function viewAllData() {
            const allData = JSON.parse(localStorage.getItem('contrastExperimentData') || '[]');
            document.getElementById('allDataDisplay').textContent = JSON.stringify(allData, null, 2);
            document.getElementById('allDataView').classList.remove('hidden');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL local research data? This will not affect data already sent to Google Sheets.')) {
                localStorage.removeItem('contrastExperimentData');
                localStorage.removeItem('experimentCompletions');
                document.getElementById('allDataView').classList.add('hidden');
                alert('All local data has been cleared.');
            }
        }

        function restartExperiment() {
            sessionStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>